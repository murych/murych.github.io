---
title: "[WIP] Проблема с созданием линейной рампы ускорения"
mathjax: true
---

## Частота

Стоит задачка _линейно_ разгонять шаговый двигатель до ~1500 оборотов в минуту и линейно же его тормозить.

Например, в ардуине (чаще всего) частота контроллера равна 16 МГц.
Число, до которого должен досчитать счетчик, для срабатывания особой функции на нужной частоте $f_i = $ кГц получается следующим образом (не вдаваясь в подробности):

$$
	n = \frac{F_{arduino}}{prescaler \cdot f_i} - 1 = \frac{16}{8 \cdot 40} - 1 = 49.
$$

Обратно эту частоту можно получить следующим образом:

$$
	f_i = \frac{F_{arduino}}{prescaler \cdot (n + 1)} = \frac{16}{8 \cdot (49 + 1)} = 40.
$$

Именно это число $$n$$, до которого будет досчитывать счетчик, и должна расчитывать программа.
Фактически, оно задает частоту вызова функции -> частоту подачи сигнала на драйвер -> частоту вращения двигателя.

## Расчеты

Умные люди задолго до нас уже придумали алгоритмы, пригодные для расчета этой задержки: [ПРУФ](https://www.embedded.com/design/mcus-processors-and-socs/4006438/Generate-stepper-motor-speed-profiles-in-real-time#).
Они аппроксимируют линейную зависимость.

![профиль скорости при линейном разгоне и торможении (без "круиза" на макисмальной скорости)](http://avrdoc.narod.ru/olderfiles/1/fig446-3-2.jpg)

Так как при аппроксимации в лоб присутствует серьезная погрешность, для ее устранения предлагается рассчитывать первую задержку отдельно по формуле
$$
	n_0 = 0.676 \cdot f \cdot \sqrt{\frac{2 MS}{accel}},
$$
где accel - ускорение, MS - дробная часть шага, на которую нужно повернуть вал.

Следующие задержки рассчитваются инкрементально (вроде это слово), т.е. следующее значение вычисляется из предыдущего:
$$
	n_i = n_{i-1} \frac{2 n_{i-1}}{4 n + 1}.
$$

Для лучшего понимания всего этого счастья лучше почитать первоисточник или перевод [тут](http://avrdoc.narod.ru/index/0-7).

## Что получилось

А получилось, что при аккуратной реализации всего вышеописанного, разгон получается нифига не линейный.
Причем адекватных способов отследить причину нет, т.к. в ардуине нет отладки, а результаты расчета на компьютере внезапно _отличаются_ от таковых на железке.
На картинках ниже все видно.

![результат выполнения кода на реальной ардуине (данные собраны через последовательный порт](https://i.ibb.co/Dt8m5wZ/arduino-set-3-freq.png)

![результат выполнения кода на локальной машине](https://i.ibb.co/7Xvmjwr/calculation.png)

Как можно видеть, на ардуине профиль получился нифига не линейным, но хотя бы близким к желаемому.
На компьютере при тех же параметрах получается ерунда.
