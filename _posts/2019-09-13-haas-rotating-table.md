---
title: "[WIP] Клепаем четвертую ось в ЧПУ станок из подручных средств"
---

> Disclaimer: в статье описано некоторое дерьмо, противопоказанное к повторению в условиях производства.

Недавно пришел заказ на партию втулок двух видов с отверстиями по периметру сечения -- по 10 и 12 отверстий, что-то вроде вот такой конструкции:

![Иллюстрация для примера](https://i.ibb.co/C6VV78Z/Free-CAD-Qq-Qfqc1-MD5.png)

Провернуть такой фокус на обычном 3-х осевом станке сложно -- придется вручную перезакреплять деталь, что почти 100% нарушит линию, по которой сверлиться.
Следовательно, нужно нечто, что зафиксирует заготовку и будет вращать её вокруг оси на заданный угол.

Для этих целей существуют _поворотные оси_ (четвертая координата, 4-я ось) для станка ЧПУ, которые предназначены для поворота деталей на различные углы при обработке.
Но мы себе такую еще не поставили, а детальки надо было делать срочно-срочно.
Решили брать то, что просто валялось под рукой -- шаговый двигатель, ардуинку и релейный выход из станка для отдачи команды о повороте детали.

На радостях было решено реализовать следующие функции:

- вход сигнала от станка с реле -- команда к повороту;
- ручное позиционирование -- по 1 шагу по/против часовой, две кнопки;
- переключение режимов 10 или 12 отверстий, один переключатель на внутреннюю подтяжку ардуины.

![Кнопочки](https://i.ibb.co/pftHsgV/eeschema-CR8-Cc-EQZMB.png)

RC цепочки, вопреки моим сподвигам были спаяны даже не на монтажной плате, а просто выводами друг к другу и к проводам.
Получившегося монстра в 2019 уже как-то даже в шутку показывать стремно.
Зато можно показать, как все это барахло уместилось в красивую коробочку, шедшую на выброс.

![Отлаживаем](https://i.ibb.co/yBXXS0k/20190911-130915.jpg)

_Отлаживаем_

![Ардуина в корпусе](https://i.ibb.co/pfBqGX9/20190911-151130.jpg)

_Ардуина в корпусе_

![С кнопочками](https://i.ibb.co/9gVLgkz/20190911-152234.jpg)

_С кнопочками_

Грязные схемотехнические костыли оправдывают (в какой-то степени) появление грязных костылей в коде.
Так, например, состояние кнопок опрашивается не по прерыванию, а просто в теле `loop()`, что, вообще-то плохо и неправильно:

{% highlight cpp %}

relayState = digitalRead(PIN_RELAY);
leftState = digitalRead(PIN_LEFT);
rightState = digitalRead(PIN_RIGHT);
rotState = digitalRead(PIN_ROT);

{% endhighlight %}

В последний раз книжку по Си я читал давненько, а область видимости переменных -- штука нечасто требующая интенсивных размышлений.
Из-за этого произошел конфуз -- как в зависимости от состояния переключателя режима создать массив шагов.
Скорее всего, проблема надуманная, но решение получилось слегка уродливым:

{% highlight cpp %}

if (!rotState)
{
    //! количество поворотов
    const int ROT = 12;
    //! количество шагов на каждый поворот
    const int move[ROT] = {34,33,33,33,34,33,33,34,33,33,33,34};
    // если сделали один полный оборот -- обнуляемся
    if (movement >= ROT)
    {
        movement = 0;
    }
    // шагаем по таблице
    for (int step = 0; step < move[movement]; step++)
    {
        digitalWrite(PIN_CLK, HIGH); delay(_delay);
        digitalWrite(PIN_CLK, LOW); delay(_delay);
        steps++;
    }
    // жалкое подобие дебага
    printRelay(movement+1, move[movement], steps);
}

{% endhighlight %}

Итак, код набросали, нужные сценарии работают.
Собираем весь "комплекс":

![Система в сборе](https://i.ibb.co/thYPGvB/20190911-154247.jpg)

_Система в сборе_

Здесь стоит сделать заметку (на фотках выше видно), что у шагового двигателя драйвер встроен прям в корпус.
А сверление предполагается проводить с подачей охлаждающей жидкости.
Встает следующий вопрос -- как изолировать электронику и вал двигателя от попадания СОЖа?

![Герметизируем вал](https://i.ibb.co/fG5mRNc/20190912-150555.jpg)

_Герметизируем вал_

![Пихаем в три пакета, изоленту и вспененный полиэтилен](https://i.ibb.co/rkvXnkk/20190912-155355.jpg)

_Пихаем в три пакета, изоленту и вспененный полиэтилен_

Прогнали тест, определили длительность импульса от станка.
Закрепляем первую деталь.

![Первая пошла](https://i.ibb.co/3T3PCkG/20190912-163949.jpg)

И о чудо -- с первой попытки получается то, что нужно!

![Успех](https://i.ibb.co/G5pH4Gn/20190912-164237.jpg)

:horns:

> UPD 14.09.2019
>
> Двигатель все же залило СОЖем, несмотря на попытки его загерметизировать.
> Хотя бы получилось сделать детали, уже хорошо.
